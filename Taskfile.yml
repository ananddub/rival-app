version: '3'

vars:
  CONFIG_FILE: config.yaml

tasks:
  sqlc-generate:
    desc: Generate sqlc code for all services
    cmds:
      - task: sqlc-auth
      - task: sqlc-activity
      - task: sqlc-notification
      - task: sqlc-wallet
      - task: sqlc-reward

  sqlc-auth:
    desc: Generate sqlc code for auth service
    dir: internal/auth
    cmds:
      - sqlc generate

  sqlc-activity:
    desc: Generate sqlc code for activity service
    dir: internal/activity
    cmds:
      - sqlc generate

  sqlc-notification:
    desc: Generate sqlc code for notification service
    dir: internal/notification
    cmds:
      - sqlc generate

  sqlc-wallet:
    desc: Generate sqlc code for wallet service
    dir: internal/wallet
    cmds:
      - sqlc generate

  sqlc-reward:
    desc: Generate sqlc code for reward service
    dir: internal/reward
    cmds:
      - sqlc generate

  migrate:
    desc: Run database migrations for all services
    cmds:
      - task: migrate-auth
      - task: migrate-activity
      - task: migrate-notification
      - task: migrate-wallet
      - task: migrate-reward

  migrate-auth:
    desc: Run auth database migrations
    cmds:
      - goose -dir internal/auth/db postgres "user=postgres password=postgres dbname=rival_db sslmode=disable" up

  migrate-activity:
    desc: Run activity database migrations
    cmds:
      - goose -dir internal/activity/db postgres "user=postgres password=postgres dbname=rival_db sslmode=disable" up

  migrate-notification:
    desc: Run notification database migrations
    cmds:
      - goose -dir internal/notification/db postgres "user=postgres password=postgres dbname=rival_db sslmode=disable" up

  migrate-wallet:
    desc: Run wallet database migrations
    cmds:
      - goose -dir internal/wallet/db postgres "user=postgres password=postgres dbname=rival_db sslmode=disable" up

  migrate-reward:
    desc: Run reward database migrations
    cmds:
      - goose -dir internal/reward/db postgres "user=postgres password=postgres dbname=rival_db sslmode=disable" up

  migrate-down:
    desc: Rollback all database migrations
    cmds:
      - goose -dir internal/auth/db postgres "user=postgres password=postgres dbname=rival_db sslmode=disable" down
      - goose -dir internal/activity/db postgres "user=postgres password=postgres dbname=rival_db sslmode=disable" down
      - goose -dir internal/notification/db postgres "user=postgres password=postgres dbname=rival_db sslmode=disable" down
      - goose -dir internal/wallet/db postgres "user=postgres password=postgres dbname=rival_db sslmode=disable" down
      - goose -dir internal/reward/db postgres "user=postgres password=postgres dbname=rival_db sslmode=disable" down

  dev:
    desc: Run development server with migrations and SQLC generation
    cmds:
      - task: migrate
      - task: sqlc-generate
      - encore run

  build:
    desc: Build the application
    cmds:
      - encore build

  test:
    desc: Run tests
    cmds:
      - encore test ./...

  clean:
    desc: Clean generated files
    cmds:
      - rm -rf internal/auth/gen/*
      - rm -rf internal/activity/gen/*
      - rm -rf internal/notification/gen/*
      - rm -rf internal/wallet/gen/*
      - rm -rf internal/reward/gen/*

  reset-db:
    desc: Reset database (drop and recreate)
    cmds:
      - task: migrate-down
      - task: migrate
      - task: sqlc-generate

  dummy-data:
    desc: Insert dummy data for testing
    cmds:
      - |
        psql "user=postgres password=postgres dbname=rival_db sslmode=disable" << 'EOF'
        -- Insert dummy users
        INSERT INTO users (name, email, phone, password, is_email_verified, is_phone_verified) VALUES
        ('John Doe', 'john@example.com', '+1234567890', '$2a$10$92IXUNpkjO0rOQ5byMi.Ye4oKoEa3Ro9llC/.og/at2.uheWG/igi', true, false),
        ('Jane Smith', 'jane@example.com', '+1234567891', '$2a$10$92IXUNpkjO0rOQ5byMi.Ye4oKoEa3Ro9llC/.og/at2.uheWG/igi', true, true),
        ('Bob Johnson', 'bob@example.com', '+1234567892', '$2a$10$92IXUNpkjO0rOQ5byMi.Ye4oKoEa3Ro9llC/.og/at2.uheWG/igi', false, false);

        -- Insert dummy wallets
        INSERT INTO wallets (user_id, balance, coins, currency) VALUES
        (1, 1000.50, 250, 'USD'),
        (2, 750.25, 180, 'USD'),
        (3, 500.00, 120, 'USD');

        -- Insert dummy transactions
        INSERT INTO transactions (user_id, wallet_id, title, description, amount, type, icon) VALUES
        (1, 1, 'Daily Login Bonus', 'Reward for daily login', 50.00, 'credit', 'gift'),
        (1, 1, 'Purchase Coffee', 'Coffee shop payment', -4.50, 'debit', 'coffee'),
        (2, 2, 'Referral Bonus', 'Friend referral reward', 25.00, 'credit', 'users'),
        (3, 3, 'Welcome Bonus', 'New user welcome bonus', 100.00, 'credit', 'star');

        -- Insert dummy activities
        INSERT INTO activities (user_id, action, details, category, icon) VALUES
        (1, 'Login', 'User logged in successfully', 'authentication', 'login'),
        (1, 'Purchase', 'Bought coffee for $4.50', 'transaction', 'shopping'),
        (2, 'Signup', 'New user registration', 'authentication', 'user-plus'),
        (3, 'Profile Update', 'Updated profile information', 'profile', 'edit');

        -- Insert dummy notifications
        INSERT INTO notifications (user_id, title, message, type, is_read) VALUES
        (1, 'Welcome!', 'Welcome to our platform', 'welcome', false),
        (1, 'Transaction Alert', 'Your purchase was successful', 'transaction', true),
        (2, 'Bonus Earned', 'You earned a referral bonus!', 'reward', false),
        (3, 'Profile Incomplete', 'Please complete your profile', 'reminder', false);

        -- Insert dummy rewards
        INSERT INTO rewards (user_id, title, description, points, type, status) VALUES
        (1, 'Daily Login', 'Login for 7 consecutive days', 100, 'daily', 'available'),
        (1, 'First Purchase', 'Make your first purchase', 50, 'milestone', 'claimed'),
        (2, 'Referral Master', 'Refer 5 friends', 200, 'referral', 'available'),
        (3, 'Profile Complete', 'Complete your profile 100%', 75, 'profile', 'available');
        EOF

  status:
    desc: Show database status
    cmds:
      - |
        psql "user=postgres password=postgres dbname=rival_db sslmode=disable" -c "
        SELECT 'users' as table_name, count(*) as count FROM users
        UNION ALL
        SELECT 'wallets', count(*) FROM wallets
        UNION ALL
        SELECT 'transactions', count(*) FROM transactions
        UNION ALL
        SELECT 'activities', count(*) FROM activities
        UNION ALL
        SELECT 'notifications', count(*) FROM notifications
        UNION ALL
        SELECT 'rewards', count(*) FROM rewards;
        "
      - task: sqlc-activity
      - task: sqlc-notification
      - task: sqlc-wallet

  sqlc-auth:
    desc: Generate sqlc code for auth service
    dir: internal/auth
    cmds:
      - ~/go/bin/sqlc generate

  sqlc-activity:
    desc: Generate sqlc code for activity service
    dir: internal/activity
    cmds:
      - ~/go/bin/sqlc generate

  sqlc-notification:
    desc: Generate sqlc code for notification service
    dir: internal/notification
    cmds:
      - ~/go/bin/sqlc generate

  sqlc-wallet:
    desc: Generate sqlc code for wallet service
    dir: internal/wallet
    cmds:
      - ~/go/bin/sqlc generate

  insert-dummy-data:
    desc: Insert dummy data for testing
    cmds:
      - |
        export DB_HOST=$(~/go/bin/yq '.database.host' {{.CONFIG_FILE}})
        export DB_PORT=$(~/go/bin/yq '.database.port' {{.CONFIG_FILE}})
        export DB_USER=$(~/go/bin/yq '.database.user' {{.CONFIG_FILE}})
        export DB_PASSWORD=$(~/go/bin/yq '.database.password' {{.CONFIG_FILE}})
        export DB_NAME=$(~/go/bin/yq '.database.dbname' {{.CONFIG_FILE}})
        PGPASSWORD=$DB_PASSWORD psql -h $DB_HOST -p $DB_PORT -U $DB_USER -d $DB_NAME -f insert_dummy_data.sql

  check-data:
    desc: Check database data counts
    cmds:
      - |
        export DB_HOST=$(~/go/bin/yq '.database.host' {{.CONFIG_FILE}})
        export DB_PORT=$(~/go/bin/yq '.database.port' {{.CONFIG_FILE}})
        export DB_USER=$(~/go/bin/yq '.database.user' {{.CONFIG_FILE}})
        export DB_PASSWORD=$(~/go/bin/yq '.database.password' {{.CONFIG_FILE}})
        export DB_NAME=$(~/go/bin/yq '.database.dbname' {{.CONFIG_FILE}})
        PGPASSWORD=$DB_PASSWORD psql -h $DB_HOST -p $DB_PORT -U $DB_USER -d $DB_NAME -c "
        SELECT 'users' as table_name, COUNT(*) as count FROM users
        UNION ALL SELECT 'wallets', COUNT(*) FROM wallets  
        UNION ALL SELECT 'transactions', COUNT(*) FROM transactions
        UNION ALL SELECT 'activities', COUNT(*) FROM activities
        UNION ALL SELECT 'notifications', COUNT(*) FROM notifications
        UNION ALL SELECT 'jwt_tokens', COUNT(*) FROM jwt_tokens;"

  fresh-migrate:
    desc: Drop all tables and run fresh migrations
    cmds:
      - task: drop-all-tables
      - task: goose-up

  drop-all-tables:
    desc: Drop all tables and reset goose version
    dir: internal/auth/db/schema
    cmds:
      - |
        export DB_HOST=$(~/go/bin/yq '.database.host' ../../../../{{.CONFIG_FILE}})
        export DB_PORT=$(~/go/bin/yq '.database.port' ../../../../{{.CONFIG_FILE}})
        export DB_USER=$(~/go/bin/yq '.database.user' ../../../../{{.CONFIG_FILE}})
        export DB_PASSWORD=$(~/go/bin/yq '.database.password' ../../../../{{.CONFIG_FILE}})
        export DB_NAME=$(~/go/bin/yq '.database.dbname' ../../../../{{.CONFIG_FILE}})
        export DB_SSL_MODE=$(~/go/bin/yq '.database.sslmode' ../../../../{{.CONFIG_FILE}})
        echo "DROP TABLE IF EXISTS public.transactions CASCADE; DROP TABLE IF EXISTS public.wallets CASCADE; DROP TABLE IF EXISTS public.notifications CASCADE; DROP TABLE IF EXISTS public.activities CASCADE; DROP TABLE IF EXISTS public.jwt_tokens CASCADE; DROP TABLE IF EXISTS public.users CASCADE; DROP TABLE IF EXISTS public.goose_db_version CASCADE;" | go run github.com/pressly/goose/v3/cmd/goose@latest postgres "host=$DB_HOST port=$DB_PORT user=$DB_USER password=$DB_PASSWORD dbname=$DB_NAME sslmode=$DB_SSL_MODE" fix

  goose-status:
    desc: Check migration status for all modules
    cmds:
      - echo "=== Auth Migration Status ==="
      - task: goose-auth-status
      - echo "=== Activity Migration Status ==="
      - task: goose-activity-status
      - echo "=== Notification Migration Status ==="
      - task: goose-notification-status
      - echo "=== Wallet Migration Status ==="
      - task: goose-wallet-status

  goose-auth-status:
    desc: Check auth migration status
    dir: internal/auth/db/schema
    cmds:
      - |
        export DB_HOST=$(~/go/bin/yq '.database.host' ../../../../{{.CONFIG_FILE}})
        export DB_PORT=$(~/go/bin/yq '.database.port' ../../../../{{.CONFIG_FILE}})
        export DB_USER=$(~/go/bin/yq '.database.user' ../../../../{{.CONFIG_FILE}})
        export DB_PASSWORD=$(~/go/bin/yq '.database.password' ../../../../{{.CONFIG_FILE}})
        export DB_NAME=$(~/go/bin/yq '.database.dbname' ../../../../{{.CONFIG_FILE}})
        export DB_SSL_MODE=$(~/go/bin/yq '.database.sslmode' ../../../../{{.CONFIG_FILE}})
        go run github.com/pressly/goose/v3/cmd/goose@latest postgres "host=$DB_HOST port=$DB_PORT user=$DB_USER password=$DB_PASSWORD dbname=$DB_NAME sslmode=$DB_SSL_MODE" status

  goose-activity-status:
    desc: Check activity migration status
    dir: internal/activity/db/schema
    cmds:
      - |
        export DB_HOST=$(~/go/bin/yq '.database.host' ../../../../{{.CONFIG_FILE}})
        export DB_PORT=$(~/go/bin/yq '.database.port' ../../../../{{.CONFIG_FILE}})
        export DB_USER=$(~/go/bin/yq '.database.user' ../../../../{{.CONFIG_FILE}})
        export DB_PASSWORD=$(~/go/bin/yq '.database.password' ../../../../{{.CONFIG_FILE}})
        export DB_NAME=$(~/go/bin/yq '.database.dbname' ../../../../{{.CONFIG_FILE}})
        export DB_SSL_MODE=$(~/go/bin/yq '.database.sslmode' ../../../../{{.CONFIG_FILE}})
        go run github.com/pressly/goose/v3/cmd/goose@latest postgres "host=$DB_HOST port=$DB_PORT user=$DB_USER password=$DB_PASSWORD dbname=$DB_NAME sslmode=$DB_SSL_MODE" status

  goose-notification-status:
    desc: Check notification migration status
    dir: internal/notification/db/schema
    cmds:
      - |
        export DB_HOST=$(~/go/bin/yq '.database.host' ../../../../{{.CONFIG_FILE}})
        export DB_PORT=$(~/go/bin/yq '.database.port' ../../../../{{.CONFIG_FILE}})
        export DB_USER=$(~/go/bin/yq '.database.user' ../../../../{{.CONFIG_FILE}})
        export DB_PASSWORD=$(~/go/bin/yq '.database.password' ../../../../{{.CONFIG_FILE}})
        export DB_NAME=$(~/go/bin/yq '.database.dbname' ../../../../{{.CONFIG_FILE}})
        export DB_SSL_MODE=$(~/go/bin/yq '.database.sslmode' ../../../../{{.CONFIG_FILE}})
        go run github.com/pressly/goose/v3/cmd/goose@latest postgres "host=$DB_HOST port=$DB_PORT user=$DB_USER password=$DB_PASSWORD dbname=$DB_NAME sslmode=$DB_SSL_MODE" status

  goose-wallet-status:
    desc: Check wallet migration status
    dir: internal/wallet/db/schema
    cmds:
      - |
        export DB_HOST=$(~/go/bin/yq '.database.host' ../../../../{{.CONFIG_FILE}})
        export DB_PORT=$(~/go/bin/yq '.database.port' ../../../../{{.CONFIG_FILE}})
        export DB_USER=$(~/go/bin/yq '.database.user' ../../../../{{.CONFIG_FILE}})
        export DB_PASSWORD=$(~/go/bin/yq '.database.password' ../../../../{{.CONFIG_FILE}})
        export DB_NAME=$(~/go/bin/yq '.database.dbname' ../../../../{{.CONFIG_FILE}})
        export DB_SSL_MODE=$(~/go/bin/yq '.database.sslmode' ../../../../{{.CONFIG_FILE}})
        go run github.com/pressly/goose/v3/cmd/goose@latest postgres "host=$DB_HOST port=$DB_PORT user=$DB_USER password=$DB_PASSWORD dbname=$DB_NAME sslmode=$DB_SSL_MODE" status

  goose-setup:
    desc: Setup goose migrations for all modules
    cmds:
      - task: goose-create-migrations
      - task: goose-up

  goose-create-migrations:
    desc: Create migration files for all modules
    cmds:
      - task: goose-create-auth
      - task: goose-create-activity  
      - task: goose-create-notification
      - task: goose-create-wallet

  goose-create-auth:
    desc: Create auth migration files
    dir: internal/auth/db/schema
    cmds:
      - |
        if [ ! -f "20241018000001_users.sql" ]; then
          cp 001_users.sql 20241018000001_users.sql
        fi
      - |
        if [ ! -f "20241018000002_jwt_tokens.sql" ]; then
          cp 002_jwt_tokens.sql 20241018000002_jwt_tokens.sql
        fi

  goose-create-activity:
    desc: Create activity migration files
    dir: internal/activity/db/schema
    cmds:
      - |
        if [ ! -f "20241018000003_activities.sql" ]; then
          cp 001_activities.sql 20241018000003_activities.sql
        fi

  goose-create-notification:
    desc: Create notification migration files
    dir: internal/notification/db/schema
    cmds:
      - |
        if [ ! -f "20241018000004_notifications.sql" ]; then
          cp 001_notifications.sql 20241018000004_notifications.sql
        fi

  goose-create-wallet:
    desc: Create wallet migration files
    dir: internal/wallet/db/schema
    cmds:
      - |
        if [ ! -f "20241018000005_wallets.sql" ]; then
          cp 001_wallets.sql 20241018000005_wallets.sql
        fi

  goose-up:
    desc: Run database migrations for all modules
    cmds:
      - task: goose-auth-up
      - task: goose-activity-up
      - task: goose-notification-up
      - task: goose-wallet-up
      - task: goose-reward-up

  goose-down:
    desc: Rollback database migrations for all modules
    cmds:
      - task: goose-wallet-down
      - task: goose-notification-down
      - task: goose-activity-down
      - task: goose-auth-down

  goose-auth-up:
    desc: Run auth migrations
    dir: internal/auth/db/schema
    cmds:
      - |
        export DB_HOST=$(~/go/bin/yq '.database.host' ../../../../{{.CONFIG_FILE}})
        export DB_PORT=$(~/go/bin/yq '.database.port' ../../../../{{.CONFIG_FILE}})
        export DB_USER=$(~/go/bin/yq '.database.user' ../../../../{{.CONFIG_FILE}})
        export DB_PASSWORD=$(~/go/bin/yq '.database.password' ../../../../{{.CONFIG_FILE}})
        export DB_NAME=$(~/go/bin/yq '.database.dbname' ../../../../{{.CONFIG_FILE}})
        export DB_SSL_MODE=$(~/go/bin/yq '.database.sslmode' ../../../../{{.CONFIG_FILE}})
        go run github.com/pressly/goose/v3/cmd/goose@latest postgres "host=$DB_HOST port=$DB_PORT user=$DB_USER password=$DB_PASSWORD dbname=$DB_NAME sslmode=$DB_SSL_MODE" up

  goose-activity-up:
    desc: Run activity migrations
    dir: internal/activity/db/schema
    cmds:
      - |
        export DB_HOST=$(~/go/bin/yq '.database.host' ../../../../{{.CONFIG_FILE}})
        export DB_PORT=$(~/go/bin/yq '.database.port' ../../../../{{.CONFIG_FILE}})
        export DB_USER=$(~/go/bin/yq '.database.user' ../../../../{{.CONFIG_FILE}})
        export DB_PASSWORD=$(~/go/bin/yq '.database.password' ../../../../{{.CONFIG_FILE}})
        export DB_NAME=$(~/go/bin/yq '.database.dbname' ../../../../{{.CONFIG_FILE}})
        export DB_SSL_MODE=$(~/go/bin/yq '.database.sslmode' ../../../../{{.CONFIG_FILE}})
        go run github.com/pressly/goose/v3/cmd/goose@latest postgres "host=$DB_HOST port=$DB_PORT user=$DB_USER password=$DB_PASSWORD dbname=$DB_NAME sslmode=$DB_SSL_MODE" up

  goose-notification-up:
    desc: Run notification migrations
    dir: internal/notification/db/schema
    cmds:
      - |
        export DB_HOST=$(~/go/bin/yq '.database.host' ../../../../{{.CONFIG_FILE}})
        export DB_PORT=$(~/go/bin/yq '.database.port' ../../../../{{.CONFIG_FILE}})
        export DB_USER=$(~/go/bin/yq '.database.user' ../../../../{{.CONFIG_FILE}})
        export DB_PASSWORD=$(~/go/bin/yq '.database.password' ../../../../{{.CONFIG_FILE}})
        export DB_NAME=$(~/go/bin/yq '.database.dbname' ../../../../{{.CONFIG_FILE}})
        export DB_SSL_MODE=$(~/go/bin/yq '.database.sslmode' ../../../../{{.CONFIG_FILE}})
        go run github.com/pressly/goose/v3/cmd/goose@latest postgres "host=$DB_HOST port=$DB_PORT user=$DB_USER password=$DB_PASSWORD dbname=$DB_NAME sslmode=$DB_SSL_MODE" up

  goose-wallet-up:
    desc: Run wallet migrations
    dir: internal/wallet/db/schema
    cmds:
      - |
        export DB_HOST=$(~/go/bin/yq '.database.host' ../../../../{{.CONFIG_FILE}})
        export DB_PORT=$(~/go/bin/yq '.database.port' ../../../../{{.CONFIG_FILE}})
        export DB_USER=$(~/go/bin/yq '.database.user' ../../../../{{.CONFIG_FILE}})
        export DB_PASSWORD=$(~/go/bin/yq '.database.password' ../../../../{{.CONFIG_FILE}})
        export DB_NAME=$(~/go/bin/yq '.database.dbname' ../../../../{{.CONFIG_FILE}})
        export DB_SSL_MODE=$(~/go/bin/yq '.database.sslmode' ../../../../{{.CONFIG_FILE}})
        go run github.com/pressly/goose/v3/cmd/goose@latest postgres "host=$DB_HOST port=$DB_PORT user=$DB_USER password=$DB_PASSWORD dbname=$DB_NAME sslmode=$DB_SSL_MODE" up

  goose-reward-up:
    desc: Run reward migrations
    dir: internal/reward/db/schema
    cmds:
      - |
        export DB_HOST=$(~/go/bin/yq '.database.host' ../../../../{{.CONFIG_FILE}})
        export DB_PORT=$(~/go/bin/yq '.database.port' ../../../../{{.CONFIG_FILE}})
        export DB_USER=$(~/go/bin/yq '.database.user' ../../../../{{.CONFIG_FILE}})
        export DB_PASSWORD=$(~/go/bin/yq '.database.password' ../../../../{{.CONFIG_FILE}})
        export DB_NAME=$(~/go/bin/yq '.database.dbname' ../../../../{{.CONFIG_FILE}})
        export DB_SSL_MODE=$(~/go/bin/yq '.database.sslmode' ../../../../{{.CONFIG_FILE}})
        go run github.com/pressly/goose/v3/cmd/goose@latest postgres "host=$DB_HOST port=$DB_PORT user=$DB_USER password=$DB_PASSWORD dbname=$DB_NAME sslmode=$DB_SSL_MODE" up

  goose-auth-down:
    desc: Rollback auth migrations
    dir: internal/auth/db/schema
    cmds:
      - |
        export DB_HOST=$(~/go/bin/yq '.database.host' ../../../../{{.CONFIG_FILE}})
        export DB_PORT=$(~/go/bin/yq '.database.port' ../../../../{{.CONFIG_FILE}})
        export DB_USER=$(~/go/bin/yq '.database.user' ../../../../{{.CONFIG_FILE}})
        export DB_PASSWORD=$(~/go/bin/yq '.database.password' ../../../../{{.CONFIG_FILE}})
        export DB_NAME=$(~/go/bin/yq '.database.dbname' ../../../../{{.CONFIG_FILE}})
        export DB_SSL_MODE=$(~/go/bin/yq '.database.sslmode' ../../../../{{.CONFIG_FILE}})
        go run github.com/pressly/goose/v3/cmd/goose@latest postgres "host=$DB_HOST port=$DB_PORT user=$DB_USER password=$DB_PASSWORD dbname=$DB_NAME sslmode=$DB_SSL_MODE" down

  goose-activity-down:
    desc: Rollback activity migrations
    dir: internal/activity/db/schema
    cmds:
      - |
        export DB_HOST=$(~/go/bin/yq '.database.host' ../../../../{{.CONFIG_FILE}})
        export DB_PORT=$(~/go/bin/yq '.database.port' ../../../../{{.CONFIG_FILE}})
        export DB_USER=$(~/go/bin/yq '.database.user' ../../../../{{.CONFIG_FILE}})
        export DB_PASSWORD=$(~/go/bin/yq '.database.password' ../../../../{{.CONFIG_FILE}})
        export DB_NAME=$(~/go/bin/yq '.database.dbname' ../../../../{{.CONFIG_FILE}})
        export DB_SSL_MODE=$(~/go/bin/yq '.database.sslmode' ../../../../{{.CONFIG_FILE}})
        go run github.com/pressly/goose/v3/cmd/goose@latest postgres "host=$DB_HOST port=$DB_PORT user=$DB_USER password=$DB_PASSWORD dbname=$DB_NAME sslmode=$DB_SSL_MODE" down

  goose-notification-down:
    desc: Rollback notification migrations
    dir: internal/notification/db/schema
    cmds:
      - |
        export DB_HOST=$(~/go/bin/yq '.database.host' ../../../../{{.CONFIG_FILE}})
        export DB_PORT=$(~/go/bin/yq '.database.port' ../../../../{{.CONFIG_FILE}})
        export DB_USER=$(~/go/bin/yq '.database.user' ../../../../{{.CONFIG_FILE}})
        export DB_PASSWORD=$(~/go/bin/yq '.database.password' ../../../../{{.CONFIG_FILE}})
        export DB_NAME=$(~/go/bin/yq '.database.dbname' ../../../../{{.CONFIG_FILE}})
        export DB_SSL_MODE=$(~/go/bin/yq '.database.sslmode' ../../../../{{.CONFIG_FILE}})
        go run github.com/pressly/goose/v3/cmd/goose@latest postgres "host=$DB_HOST port=$DB_PORT user=$DB_USER password=$DB_PASSWORD dbname=$DB_NAME sslmode=$DB_SSL_MODE" down

  goose-wallet-down:
    desc: Rollback wallet migrations
    dir: internal/wallet/db/schema
    cmds:
      - |
        export DB_HOST=$(~/go/bin/yq '.database.host' ../../../../{{.CONFIG_FILE}})
        export DB_PORT=$(~/go/bin/yq '.database.port' ../../../../{{.CONFIG_FILE}})
        export DB_USER=$(~/go/bin/yq '.database.user' ../../../../{{.CONFIG_FILE}})
        export DB_PASSWORD=$(~/go/bin/yq '.database.password' ../../../../{{.CONFIG_FILE}})
        export DB_NAME=$(~/go/bin/yq '.database.dbname' ../../../../{{.CONFIG_FILE}})
        export DB_SSL_MODE=$(~/go/bin/yq '.database.sslmode' ../../../../{{.CONFIG_FILE}})
        go run github.com/pressly/goose/v3/cmd/goose@latest postgres "host=$DB_HOST port=$DB_PORT user=$DB_USER password=$DB_PASSWORD dbname=$DB_NAME sslmode=$DB_SSL_MODE" down

  dev:
    desc: Run development server
    cmds:
      - encore run

  build:
    desc: Build the application
    cmds:
      - go build -o bin/rival ./...

  run:
    desc: Run the application
    cmds:
      - encore run --listen=0.0.0.0:4000
